trigger:
- main  # Change this to match your branch

pool:
  vmImage: 'ubuntu-latest'

variables:
  terraformVersion: '1.5.0'  # Adjust as needed
  azureSubscription: 'Software Development (15e60859-88d7-4c84-943f-55488479910c)'
  workingDirectory: 'terraform'  # Path to your Terraform configuration files

stages:
- stage: Terraform_Deploy
  displayName: "Deploy Terraform Infrastructure"
  jobs:
  - job: Terraform
    displayName: "Run Terraform"
    steps:
    
    # ✅ Checkout the repository
    - checkout: self
    
    # ✅ Ensure Terraform is installed
    - task: TerraformInstaller@1
      displayName: "Install Terraform"
      inputs:
        terraformVersion: $(terraformVersion)

    # ✅ Verify Terraform Installation
    - script: terraform version
      displayName: "Check Terraform Installation"

    # ✅ Authenticate to Azure
    - task: AzureCLI@2
      displayName: "Azure Login"
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az login --service-principal -u $(AZURE_CLIENT_ID) -p $(AZURE_CLIENT_SECRET) --tenant $(AZURE_TENANT_ID)
          az account set --subscription $(azureSubscription)

    # ✅ Terraform Init
    - task: TerraformTaskV2@2
      displayName: "Terraform Init"
      inputs:
        command: 'init'
        workingDirectory: $(workingDirectory)
        backendType: 'azurerm'
        backendServiceArm: $(azureSubscription)
        backendAzureRmResourceGroupName: 'Goreg4'
        backendAzureRmStorageAccountName: 'yourstorageaccount'
        backendAzureRmContainerName: 'terraform-state'
        backendAzureRmKey: 'terraform.tfstate'

    # ✅ Terraform Plan
    - task: TerraformTaskV2@2
      displayName: "Terraform Plan"
      inputs:
        command: 'plan'
        workingDirectory: $(workingDirectory)
        environmentServiceNameAzureRM: $(azureSubscription)

    # ✅ Terraform Apply (Auto Approve)
    - task: TerraformTaskV2@2
      displayName: "Terraform Apply"
      inputs:
        command: 'apply'
        workingDirectory: $(workingDirectory)
        environmentServiceNameAzureRM: $(azureSubscription)
        commandOptions: '-auto-approve'
