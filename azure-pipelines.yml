trigger:
- main

stages:
- stage: DeployMonitoring
  displayName: Deploy Monitoring Tools
  jobs:
  - job: DeployPrometheusGrafana
    displayName: Deploy Prometheus and Grafana
    pool:
      vmImage: 'ubuntu-latest'

    steps:
    - script: |
        echo "Installing Terraform CLI..."
        curl -fsSL https://releases.hashicorp.com/terraform/1.5.6/terraform_1.5.6_linux_amd64.zip -o terraform.zip
        unzip terraform.zip
        sudo mv terraform /usr/local/bin/
        terraform --version
      displayName: Install Terraform CLI

    - script: |
        echo "Installing kubectl..."
        sudo az aks install-cli
        kubectl version --client
      displayName: Install kubectl

    - script: |
        echo "Authenticating to Azure..."
        az login --service-principal -u $(client_id) -p $(client_secret) --tenant $(tenant_id)
        az aks get-credentials --resource-group $(resource_group) --name $(aks_name) --file kubeconfig
        echo "Kubeconfig created"
      displayName: Azure Login and AKS Configuration

    - script: |
        echo "Initializing Terraform..."
        terraform init
        terraform validate
        terraform plan -out=tfplan
        terraform apply -auto-approve
      displayName: Deploy with Terraform

      env:
        ARM_CLIENT_ID: $(client_id)
        ARM_CLIENT_SECRET: $(client_secret)
        ARM_SUBSCRIPTION_ID: $(subscription_id)
        ARM_TENANT_ID: $(tenant_id)
