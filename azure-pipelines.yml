trigger:
  branches:
    include:
      - dev  # Replace with your branch name

variables:
  azure_subscription: 'Software Development (15e60859-88d7-4c84-943f-55488479910c)'
  RESOURCE_GROUP_NAME: "POCMyResourceGroup"
  STORAGE_ACCOUNT_NAME: "pocmystorageacct123"
  CONTAINER_NAME: "tfstate"
  LOCATION: "eastus"  # Corrected location format
  NODE_COUNT: 2
  AKS_NAME: "MyAKSCluster"
  # Hardcoded values for debugging
  AZURE_CLIENT_ID: '9a7b7fdd-5a88-46e3-8d9b-b78042012e30'
  AZURE_TENANT_ID: 'fd3a4a13-0cd8-4c1c-ba4c-e4995f5ee282'
  AZURE_CLIENT_SECRET: 's6h8Q~WNY_QKu92SobDd7FnfSIWJsYSYmKeF2dw0'
  AZURE_SUBSCRIPTION_ID: '15e60859-88d7-4c84-943f-55488479910c'

stages:
# Stage 1: Terraform Init and Apply
- stage: TerraformDeployment
  displayName: "Terraform Init and Apply"
  jobs:
    - job: TerraformJob
      displayName: "Run Terraform"
      pool:
        vmImage: 'ubuntu-latest'
      steps:
        # Checkout the repository
        - task: Checkout@1

        # Install Terraform
        - task: TerraformInstaller@0
          inputs:
            terraformVersion: '1.5.0'

        # Run Terraform Commands
        - script: |
            # Set Azure authentication environment variables
            export ARM_CLIENT_ID="9a7b7fdd-5a88-46e3-8d9b-b78042012e30"
            export ARM_CLIENT_SECRET="s6h8Q~WNY_QKu92SobDd7FnfSIWJsYSYmKeF2dw0"
            export ARM_TENANT_ID="fd3a4a13-0cd8-4c1c-ba4c-e4995f5ee282"
            export ARM_SUBSCRIPTION_ID="15e60859-88d7-4c84-943f-55488479910c"

            # Remove any previous state or lock file issues
            rm -rf .terraform .terraform.lock.hcl tfplan

            # Initialize Terraform
            terraform init -upgrade \
              -backend-config="resource_group_name=POCMyResourceGroup" \
              -backend-config="storage_account_name=pocmystorageacct123" \
              -backend-config="container_name=tfstate" \
              -backend-config="key=terraform.tfstate"

            # Plan and Apply Terraform
            terraform plan -out=tfplan
            terraform apply -auto-approve tfplan
          displayName: "Run Terraform Init, Plan, and Apply"