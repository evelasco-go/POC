trigger:
- main  # Change to your branch if needed

pool:
  vmImage: 'ubuntu-latest'

variables:
  terraformVersion: '1.5.0'  # Adjust version as needed
  azureSubscription: 'Software Development (15e60859-88d7-4c84-943f-55488479910c)'  # Name of your Azure DevOps service connection
  workingDirectory: 'terraform'  # Path to Terraform configuration files

stages:
- stage: Terraform_Deploy
  displayName: "Deploy Terraform Infrastructure"
  jobs:
  - job: Terraform
    displayName: "Run Terraform"
    steps:
    
    # ✅ Checkout the repository
    - checkout: self
    
    # ✅ Install Terraform
    - task: TerraformInstaller@1
      displayName: "Install Terraform"
      inputs:
        terraformVersion: $(terraformVersion)

    # ✅ Authenticate to Azure
    - task: AzureCLI@2
      displayName: "Azure Login"
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az login --identity || az login --service-principal -u $(ARM_CLIENT_ID) -p $(ARM_CLIENT_SECRET) --tenant $(ARM_TENANT_ID)

    # ✅ Terraform Init
    - task: TerraformTaskV2@2
      displayName: "Terraform Init"
      inputs:
        command: 'init'
        workingDirectory: $(workingDirectory)
        backendType: 'azurerm'
        backendServiceArm: $(azureSubscription)
        backendAzureRmResourceGroupName: 'Goreg4'
        backendAzureRmStorageAccountName: 'yourstorageaccount'
        backendAzureRmContainerName: 'terraform-state'
        backendAzureRmKey: 'terraform.tfstate'

    # ✅ Terraform Plan
    - task: TerraformTaskV2@2
      displayName: "Terraform Plan"
      inputs:
        command: 'plan'
        workingDirectory: $(workingDirectory)
        environmentServiceNameAzureRM: $(azureSubscription)

    # ✅ Terraform Apply (Auto Approve)
    - task: TerraformTaskV2@2
      displayName: "Terraform Apply"
      inputs:
        command: 'apply'
        workingDirectory: $(workingDirectory)
        environmentServiceNameAzureRM: $(azureSubscription)
        commandOptions: '-auto-approve'
