trigger:
  branches:
    include:
      - dev

variables:
  azure_subscription: 'Software Development (15e60859-88d7-4c84-943f-55488479910c)'
  RESOURCE_GROUP_NAME: "POCMyResourceGroup"
  STORAGE_ACCOUNT_NAME: "pocmystorageacct123"
  CONTAINER_NAME: "tfstate"
  LOCATION: "eastus"
  NODE_COUNT: 2
  AKS_NAME: "MyAKSCluster"
  AZURE_CLIENT_ID: '9a7b7fdd-5a88-46e3-8d9b-b78042012e30'
  AZURE_TENANT_ID: 'fd3a4a13-0cd8-4c1c-ba4c-e4995f5ee282'
  AZURE_CLIENT_SECRET: 's6h8Q~WNY_QKu92SobDd7FnfSIWJsYSYmKeF2dw0'
  AZURE_SUBSCRIPTION_ID: '15e60859-88d7-4c84-943f-55488479910c'

stages:
  - stage: InstallTerraform
    displayName: "Install Terraform"
    jobs:
      - job: InstallTerraformJob
        displayName: "Install Terraform"
        steps:
          - task: TerraformInstaller@0
            inputs:
              terraformVersion: '1.10.4'

  - stage: TerraformInitAndPlan
    displayName: "Initialize and Plan Terraform"
    dependsOn: InstallTerraform
    jobs:
      - job: TerraformInitAndPlanJob
        displayName: "Terraform Init and Plan"
        steps:
          - script: |
              sudo chmod -R 777 /home/vsts/work/1/s/.git
            displayName: 'Fix Git Permissions'

          - task: AzureCLI@2
            displayName: "Check and Import Existing Storage Container"
            inputs:
              azureSubscription: $(azure_subscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                set -e
                export ARM_CLIENT_ID=$(AZURE_CLIENT_ID)
                export ARM_CLIENT_SECRET=$(AZURE_CLIENT_SECRET)
                export ARM_TENANT_ID=$(AZURE_TENANT_ID)
                export ARM_SUBSCRIPTION_ID=$(AZURE_SUBSCRIPTION_ID)

                # Check if the container exists
                EXISTING_CONTAINER=$(az storage container exists --name $(CONTAINER_NAME) --account-name $(STORAGE_ACCOUNT_NAME) --query "exists" -o tsv)

                if [ "$EXISTING_CONTAINER" == "true" ]; then
                  echo "Container exists. Importing into Terraform state..."
                  terraform import azurerm_storage_container.container /subscriptions/$(AZURE_SUBSCRIPTION_ID)/resourceGroups/$(RESOURCE_GROUP_NAME)/providers/Microsoft.Storage/storageAccounts/$(STORAGE_ACCOUNT_NAME)/blobServices/default/containers/$(CONTAINER_NAME)
                else
                  echo "Container does not exist. Proceeding without import."
                fi

          - script: |
              terraform init -upgrade \
                -backend-config="resource_group_name=$(RESOURCE_GROUP_NAME)" \
                -backend-config="storage_account_name=$(STORAGE_ACCOUNT_NAME)" \
                -backend-config="container_name=$(CONTAINER_NAME)" \
                -backend-config="key=terraform.tfstate"
              terraform plan -out terraform.plan
            displayName: 'Terraform Init and Plan'

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: $(Build.SourcesDirectory)
              ArtifactName: 'terraform-plan'
              publishLocation: 'Container'

  - stage: TerraformApply
    displayName: "Apply Terraform Plan"
    dependsOn: TerraformInitAndPlan
    condition: succeeded()
    jobs:
      - job: TerraformApplyJob
        displayName: "Apply Terraform Plan"
        steps:
          - script: |
              sudo chmod -R 777 /home/vsts/work/1/s/.git
            displayName: 'Fix Git Permissions Before Apply'

          - task: DownloadPipelineArtifact@2
            inputs:
              buildType: 'current'
              artifactName: 'terraform-plan'

          - task: AzureCLI@2
            displayName: "Apply Terraform Plan"
            inputs:
              azureSubscription: $(azure_subscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                set -e
                cd $(Build.SourcesDirectory)
                export ARM_CLIENT_ID=$(AZURE_CLIENT_ID)
                export ARM_CLIENT_SECRET=$(AZURE_CLIENT_SECRET)
                export ARM_TENANT_ID=$(AZURE_TENANT_ID)
                export ARM_SUBSCRIPTION_ID=$(AZURE_SUBSCRIPTION_ID)

                # Reinitialize Terraform
                terraform init -upgrade \
                  -backend-config="resource_group_name=$(RESOURCE_GROUP_NAME)" \
                  -backend-config="storage_account_name=$(STORAGE_ACCOUNT_NAME)" \
                  -backend-config="container_name=$(CONTAINER_NAME)" \
                  -backend-config="key=terraform.tfstate"

                # Apply the Terraform plan
                terraform apply -auto-approve terraform.plan
