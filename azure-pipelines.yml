trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  azure_subscription_id: "15e60859-88d7-4c84-943f-55488479910c"
  azure_client_id: "9a7b7fdd-5a88-46e3-8d9b-b78042012e30"
  azure_client_secret: "s6h8Q~WNY_QKu92SobDd7FnfSIWJsYSYmKeF2dw0"
  azure_tenant_id: "fd3a4a13-0cd8-4c1c-ba4c-e4995f5ee282"
  resource_group_name: "POCMyResourceGroup"
  storage_account_name: "pocmystorageacct123"
  container_name: "tfstate"
  aks_name: "MyAKSCluster"
  node_count: "2"
  location: "East US"

steps:
- script: |
    echo "Logging into Azure..."
    az login --service-principal \
      --username $(azure_client_id) \
      --password $(azure_client_secret) \
      --tenant $(azure_tenant_id)
    az account set --subscription $(azure_subscription_id)
  displayName: "Login to Azure using Azure CLI"

- script: |
    echo "Installing Terraform..."
    sudo apt-get update -y
    sudo apt-get install -y gnupg software-properties-common
    curl -fsSL https://apt.releases.hashicorp.com/gpg | gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
    echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
    sudo apt-get update -y
    sudo apt-get install terraform -y
    terraform --version
  displayName: "Install Terraform"

- script: |
    echo "Initializing Terraform..."
    terraform init \
      -backend-config="resource_group_name=$(resource_group_name)" \
      -backend-config="storage_account_name=$(storage_account_name)" \
      -backend-config="container_name=$(container_name)" \
      -backend-config="key=terraform.tfstate"
    terraform plan -out terraform.plan
  displayName: "Terraform Init and Plan"

- script: |
    echo "Applying Terraform plan..."
    terraform apply -auto-approve "terraform.plan"
  displayName: "Terraform Apply"

- script: |
    echo "Cleaning up Azure CLI session..."
    az account clear
  displayName: "Clear Azure CLI session"
